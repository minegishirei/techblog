



軽量なベースイメージ

https://zenn.dev/tsucchiiinoko/articles/7c096f387e8251




## マルチステージビルド

マルチステージ ビルドmulti-stage build
このチュートリアル内ではあまり深く扱いませんが、イメージ作成時に複数の 段階stage を使える大変強力なツールが マルチステージ ビルドmulti-stage build です。いくつかの利点があります。

構築時の依存関係と、実行時の依存関係を分離できる

アプリケーションが実行に必要なもの「だけ」送るので、イメージ全体の容量を削減できる


https://docs.docker.jp/get-started/09_image_best.html#part9-next-steps



今回学んだこと

 - 公式ドキュメントはしっかり読んだ方がいい！

## 0からコンテナを作成する

https://docs.docker.jp/get-started/11_what_next.html#creating-a-container-from-scratch



# Hibiya.tech 

DevelopersIOでブログを書くクラスメソッド社員が話したいことを話して、都度参加者とディスカッションを行う。
 -> 登壇したい方がいたら、アンケートに回答して登壇可能。



今回のテーマ、どうする？コンテナセキュリティ


# サーバーのセキュリティ対策とコンテナのセキュリティ対策の違い

「emi」さんが登壇。クラスメソッド所属、AWS構築など


# 仮想サーバーとコンテナの違い

仮想サーバーはハイパーバーざーの上に乗っている。

コンテナはdockerの上でのサービスが動いている。

コンテナは、linuxカーネルの機能を利用して、プロセスの実行空有感を分離したもの



- namespace この二つでプロセスを分離している。
- cgroup 物理的なリソースの割り当てを制限している。

コンテナの一番の特徴。（仮想サーバーとの違い）
カーネルを共有している。


```sh
docker run ubuntu bash
```

sleep 10000
bg 



ホストOSで確認できてしまう。

コンテナの中のプロセスが、ホストOSでも見えている


ホストOSへの攻撃は、コンテナの中まで有効である。



セキュリティ教会。
システムかん、リソースかんのセキュリティ協会が多ければ多いほど、侵入は難しくなる。


ハイパーバーざーはハイパーバイザーが環境を分離している。

dockerは linux kernelが環境を分離している。


dockerの場合、仮想サーバーより分離が弱い。



## カーネルについて

カーネルについて、

異なるプロセス間でメモリ共有も可能。プロセスはお互いある程度見えてしまう。

2500万行ある


## ハイパーバイザーについて

ある仮想サーバーのプロセスは他の仮想サーバーから見ることはない。

## 結論

コンテナの方が難しい！！！



## コンテナの分離の強化

コンテナ動詞を干渉し合わないようにするためには？

- seccomp : システムコールを制限することで、セキュリティ強化可能
- AppArmer : 

コンテナのSnadbox化きのう

- gVisor

Googleが開発

独自のゲストカーネルを使用して、コンテナをサンドボックス


- Kata container

コンテナを別の仮想サーバーで起動する技術。
アプリケーションコードが実行される別のターゲットホストとの間にプロキシを作成

仮想サーバーが起動するまで時間がかかってしまうのはデメリット


## コンテナのセキュリティといえば、イメージスキャン

Trivy

Clair

などなど、大量にある。


## 仮想サーバーでも、イメージスキャンがある

EC2 Image Builderでゴールデンイメージを管理することがある



# GuardDutyとsysdig の比較をしてみる

登壇者：菊池さん
徹夜したマン


- GuardDutyはAWSのきのう

ランタイムモニタリングが可能。

AWSのECSのランタイムセキュリティが可能。

- sysdigという会社のSaaS製品もある


# 前提

ECS Fargate環境を前提とします。

ランタイムセキュリティ機能に絞って話します。

サービスの比較になりますが、どちらかのサービスを貶す意図はない。


## ランタイムセキュリティとは

実行中のコンテナを保護すること

よくある方法は、実行中のコンテナを保護すること

- 以下のような攻撃は防げる
    - コンテナの中に含まれたマルウェアによる攻撃
    - コンテナイメージに含まれる脆弱性を利用した攻撃

コンテナに含まれる脆弱性はビルド時にもチェックするが、ゼロディ脆弱性など、ビルド時に洗い出せないものも -> いわば最後の防衛戦

- GuardDuty
    - AWS環境に対する脅威検出サービス
    - 2023/11アップデートにて、ECSに対するRuntime Monitoringが追加

- Sysdig
    - コンテナ、Kubernetes、クラウド環境向けセキュリティ


## GuardDutyでの通知

- GuardFutyで発生したイベントは、EventBridgeに送信される。
- 発見から5分以内に通知する
- 同一ECSタスク内部で複数回同じ攻撃を受けた場合、全て一つの通知に集約される
- 異なるECSでは別イベントとしてカウント


## GuardyDutyd ネオ通知

3.13:34 タスクAで暗号通貨関連のドメインに対してnslookup実施
3.13:40 タスクBで暗号通貨関連のドメインに対してnslookup実施
3.15:50  GuardDutyにタスクAのイベント作成
3.15:50  GuardDutyにタスクAのイベント作成
Event通知 
3.20


## Sysdigでの通知

- Notification ChannnelsとRvent Forwardingの2種類のイベント送信方法が存在

- Notification Vhannelsはポリシー違反に対する送信を行う
    - Slack Email Amazon SNSなどにイベント通知可能
- Event ForwardingはAWS等
のクラウドアカウントやコンテナで発生したポリシー違反等のセキュリtぇいイベントをElastic 


Sysdigエージェントはサイドカー方式で動く。

sysdig secureというsysdigバックエンドに送信。


19:53:18 タスクAで不審なネットワークツール(ncat)実行
19:53:23 タスクAで不審なネットワークツール(ncat)実行
19:53:42 SQSからLambdaが起動
19:54:42 SQSからLambdaが起動


## 料金比較


GuardDuty ランタイムモニタリングの価格モデル

- 2vCPU使うタスクが10個の条件で試算すると
- 月額40D


AWSの方が断然安い。



SYsdigの価格モデル

- 2vCPU使うタスクが10個の条件で試算すると
- 370USD



## 検知ルールとカスタマイズ

GuardDutyランタイムモニタリングの検知ルール

- ルール数は2/16で31こ
    - torネットワークへの接続
    - リバースシェルなど
    - 悪用ドメイン


- しかし、カスタマイズは不可
- 不要なルールは制御可能
- 悪用ドメインのリストはブラックボックス


## sysdigの検知ルール

100以上
各ルールには種別を示すタグが複数ついている

- MITRE やATT&CKなどのセキュリティ標準に殉教したルールにはそれに示すタグがつく。

- ポイント : **詳細な検知条件まで公開されている**
- ipのブラックリストも公開されている



## GuardDutyのセットアップはマジで簡単。

3秒でできる

VPCエンドポイントは自動でできてくれる。

ECSタスクも、自動で作ってくれる。

## sysdigについて

sysdigはterraformとcloudformationが用意されている。

簡単っちゃ簡単だが... 徹夜した原因の8割ぐらいがこれを占めている。



# AWSのBuildpacksをつかぅてDockerfileレスにできるのか?

佐藤智樹さん

## Buildpacks

CX事業本部 製造ビジネステクノロジー部

## AWS上でのコンテナセキュリティ概要

ECS on Fargateについては以前この資料でまとめました。

AWSで言うと、

NetworkからApplicationまでを見なければならない


## Dockerfileを書くベストプラクティスがたくさんある

- 一時的なコンテナを作成
- アプリケーションを切り離す...
- レイヤーの数を最小限に

やることが多い。


Dockerfileの代替ツールの一つで、Dockerfileを使わずにOpen Container Intiative (OCI0)



## 通常の世界

ソースコード読み取り

Dockerfile

Container Image

## CNBの世界

ソースコードを読み取って、 Imageを自動的に作る


## Google　Cloudの場合

CNBの仕様を実装し、Google Cloudの各サービスにデプロイ可能なコンテナをビルドして構成するように設計されている


## Azureの場合
azure　cぃに　cnbの park cliが組み込まれている


## AWS

くそ



- ? 理解の確認 package.jsonや requirements.txt
- ? 中身は見えるのか Dockerfileはどこかにあるのか ?
    - 極めたらすごそう


## 普及していない理由

- CPUがarmあーきだと大変
- 開発環境がソースによって変わってしまう
- CNBの情報が少ない
- Unix.socketを作成しないソフト(fintch)では使えない? ランチャーデスクトップお勧め
- 脆弱性アラートが出た時の対応がむずい




# コンテナセキュリティの概要とデプロイフロ＾に組み込んだ後の課題


## Gunosy

SREチームマネージャー

security hub芸人

security hub, guardduty, サポート



## コンテナセキュリティの概要

AWSの責任共有モデル

結果的に、コンテナより低レイヤーのセキュリティの方が大事だったりする。


コンテナへの攻撃keiro

- ホストアプリ
- コンテナランタイム / オーケストレーたー

コンテナ

- 汚染されたコンテナイメージ







## レイヤー別のセキュリティ

クラウド環境 | ミスコンフィグ
ホストOS |  ハードにんぐ
オーケストレーター | ミスコンフィグ,ランタイムセキュリティ
Dokerfile | 機密情報、特権など
Base Image | OSSライブラリの脆弱性
アプリケーション　| コードの脆弱性








## デプロイフローへの組み込み

パイプラインの全ての段階で、防御が必要

開発の手元で、スキャンが必要！

コード、OSS、


- githubリポジトリで定期的、自動的にスキャン
- ECRに載せたら、定期的にスキャン
- ECS, EKSでも定期的にスキャン


本番環境への導入

- Inspector
- Guard Duty  CIS benchmark準拠のsecurity hubに送る


IaCスキャン導入

- WebUIで全社統一ルールを作れる
- snyk reviewdog + OSSでのスキャンを試したが、snkの準拠機能のPRチェックで充足できた。


Codeスキャン導入

- vscode拡張機能で、snykを導入

















## CDB






































https://docs.docker.jp/network/iptables.html


