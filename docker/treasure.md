





Hibiya.tech 

DevelopersIOでブログを書くクラスメソッド社員が話したいことを話して、都度参加者とディスカッションを行う。
 -> 登壇したい方がいたら、アンケートに回答して登壇可能。



今回のテーマ、どうする？コンテナセキュリティ


# サーバーのセキュリティ対策とコンテナのセキュリティ対策の違い

「emi」さんが登壇。クラスメソッド所属、AWS構築など


# 仮想サーバーとコンテナの違い

仮想サーバーはハイパーバーざーの上に乗っている。

コンテナはdockerの上でのサービスが動いている。

コンテナは、linuxカーネルの機能を利用して、プロセスの実行空有感を分離したもの



- namespace この二つでプロセスを分離している。
- cgroup 物理的なリソースの割り当てを制限している。

コンテナの一番の特徴。（仮想サーバーとの違い）
カーネルを共有している。


```sh
docker run ubuntu bash
```

sleep 10000
bg 



ホストOSで確認できてしまう。

コンテナの中のプロセスが、ホストOSでも見えている


ホストOSへの攻撃は、コンテナの中まで有効である。



セキュリティ教会。
システムかん、リソースかんのセキュリティ協会が多ければ多いほど、侵入は難しくなる。


ハイパーバーざーはハイパーバイザーが環境を分離している。

dockerは linux kernelが環境を分離している。


dockerの場合、仮想サーバーより分離が弱い。



## カーネルについて

カーネルについて、

異なるプロセス間でメモリ共有も可能。プロセスはお互いある程度見えてしまう。

2500万行ある


## ハイパーバイザーについて

ある仮想サーバーのプロセスは他の仮想サーバーから見ることはない。

## 結論

コンテナの方が難しい！！！



## コンテナの分離の強化

コンテナ動詞を干渉し合わないようにするためには？

- seccomp : システムコールを制限することで、セキュリティ強化可能
- AppArmer : 

コンテナのSnadbox化きのう

- gVisor

Googleが開発

独自のゲストカーネルを使用して、コンテナをサンドボックス


- Kata container

コンテナを別の仮想サーバーで起動する技術。
アプリケーションコードが実行される別のターゲットホストとの間にプロキシを作成

仮想サーバーが起動するまで時間がかかってしまうのはデメリット


## コンテナのセキュリティといえば、イメージスキャン

Trivy

Clair

などなど、大量にある。


## 仮想サーバーでも、イメージスキャンがある

EC2 Image Builderでゴールデンイメージを管理することがある



# GuardDutyとsysdig の比較をしてみる

登壇者：菊池さん
徹夜したマン


- GuardDutyはAWSのきのう

ランタイムモニタリングが可能。

AWSのECSのランタイムセキュリティが可能。

- sysdigという会社のSaaS製品もある


# 前提

ECS Fargate環境を前提とします。

ランタイムセキュリティ機能に絞って話します。

サービスの比較になりますが、どちらかのサービスを貶す意図はない。


## ランタイムセキュリティとは

実行中のコンテナを保護すること

よくある方法は、実行中のコンテナを保護すること

- 以下のような攻撃は防げる
    - コンテナの中に含まれたマルウェアによる攻撃
    - コンテナイメージに含まれる脆弱性を利用した攻撃

コンテナに含まれる脆弱性はビルド時にもチェックするが、ゼロディ脆弱性など、ビルド時に洗い出せないものも -> いわば最後の防衛戦

- GuardDuty
    - AWS環境に対する脅威検出サービス
    - 2023/11アップデートにて、ECSに対するRuntime Monitoringが追加

- Sysdig
    - コンテナ、Kubernetes、クラウド環境向けセキュリティ


## GuardDutyでの通知

- GuardFutyで発生したイベントは、EventBridgeに送信される。
- 発見から5分以内に通知する
- 同一ECSタスク内部で複数回同じ攻撃を受けた場合、全て一つの通知に集約される
- 異なるECSでは別イベントとしてカウント


## GuardyDutyd ネオ通知

3.13:34 タスクAで暗号通貨関連のドメインに対してnslookup実施
3.13:40 タスクBで暗号通貨関連のドメインに対してnslookup実施
3.15:50  GuardDutyにタスクAのイベント作成
3.15:50  GuardDutyにタスクAのイベント作成
Event通知 
3.20


## Sysdigでの通知

- Notification ChannnelsとRvent Forwardingの2種類のイベント送信方法が存在

- Notification Vhannelsはポリシー違反に対する送信を行う
    - Slack Email Amazon SNSなどにイベント通知可能
- Event ForwardingはAWS等
のクラウドアカウントやコンテナで発生したポリシー違反等のセキュリtぇいイベントをElastic 


Sysdigエージェントはサイドカー方式で動く。

sysdig secureというsysdigバックエンドに送信。


19:53:18 タスクAで不審なネットワークツール(ncat)実行
19:53:23 タスクAで不審なネットワークツール(ncat)実行
19:53:42 SQSからLambdaが起動
19:54:42 SQSからLambdaが起動


## 料金比較


GuardDuty ランタイムモニタリングの価格モデル

- 2vCPU使うタスクが10個の条件で試算すると
- 月額40D


AWSの方が断然安い。



SYsdigの価格モデル

- 2vCPU使うタスクが10個の条件で試算すると
- 370USD



## 検知ルールとカスタマイズ

GuardDutyランタイムモニタリングの検知ルール

- ルール数は2/16で31こ
    - torネットワークへの接続
    - リバースシェルなど
    - 悪用ドメイン


- しかし、カスタマイズは不可
- 不要なルールは制御可能
- 悪用ドメインのリストはブラックボックス


## sysdigの検知ルール

100以上
各ルールには種別を示すタグが複数ついている

- MITRE やATT&CKなどのセキュリティ標準に殉教したルールにはそれに示すタグがつく。

- ポイント : **詳細な検知条件まで公開されている**
- ipのブラックリストも公開されている



## GuardDutyのセットアップはマジで簡単。

3秒でできる

VPCエンドポイントは自動でできてくれる。

ECSタスクも、自動で作ってくれる。

## sysdigについて

sysdigはterraformとcloudformationが用意されている。

簡単っちゃ簡単だが... 徹夜した原因の8割ぐらいがこれを占めている。






































https://docs.docker.jp/network/iptables.html


