

- [コードレビューとは何か？](#コードレビューとは何か)
- [The Zen Programmer](#the-zen-programmer)
- [コードレビュー手順](#コードレビュー手順)
- [コードレビューのメリット](#コードレビューのメリット)
- [コードレビューの注意点（やってはいけないこと）](#コードレビューの注意点やってはいけないこと)
  - [レビュアーは、個人的な意見のために代替案を提案するべきではありません。](#レビュアーは個人的な意見のために代替案を提案するべきではありません)
  - [速度やアルゴリズムの完璧性のみを追求する](#速度やアルゴリズムの完璧性のみを追求する)
  - [コードの一貫性を「知っているふりをする」](#コードの一貫性を知っているふりをする)
  - [ソースコードを私物化するような発言](#ソースコードを私物化するような発言)
  - [知らなかったことを認めない](#知らなかったことを認めない)
  - [複数人でレビューする](#複数人でレビューする)
- [結論](#結論)
- [備考](#備考)


## コードレビューとは何か？

コードレビューは、多くの場合そのコードをコードベースに導入する前に作成者以外の誰かがコードをレビューするプロセスです。

これは単純な定義ですが、コードレビューの実践プロセスでは、企業ごとの様々な事情に多様に変化します。

- ある組織では、チームごとに変更をレビューするコードベース全体の「番人」と呼ばれる選抜された人々が存在し、彼らがレビューを行います。

- またある組織では、レビュープロセスを小規模なチームに委任して、チームごとに異なるレベルのコードレビューを要求できるようにする人もいます。


**コードレビューには、心構えとコードレビュープロセスをサポートするツールの組み合わせが必要です。**

Google では、 プロセスをサポートするためにカスタムコードレビューツール **「Critique」** を使用しています。

Critiqueについては後ほど紹介します。今回は特定のツールではなくGoogleで実践されているコードレビューの心構えに焦点を当てます



## The Zen Programmer

（私見含む）

ほとんどのエンジニアは、自分が追加した機能が使われるという前提でコードを書いています。

あるいは「ユーザーが必要だと言ったからその機能を提供するのだ」というかもしれません。

ですがコードを書く際には、（あるいはその前の要件定義の段階で）次の事を頭の中に刻んでおいてください。

**あなたが追加するその機能は80%の確率で不要である。**

この80%という確率は「パレートの法則」に由来しています。

```txt
パレートの法則（パレートのほうそく）は、イタリアの経済学者ヴィルフレド・パレートが発見した冪乗則。
経済において、全体の数値の大部分は、全体を構成するうちの一部の要素が生み出しているとした。80:20の法則、ばらつきの法則とも呼ばれる。
```

https://ja.wikipedia.org/wiki/パレートの法則

この法則によれば、**物事の本質は全体の2割に詰まっています。**

実際にその通りであるかどうかは議論の余地があると思いますが、少なくとも私は「ソフトウェアを構成する重要な要素は2割に満たない」と考えてます。

- OfficeのWordの機能をすべて活用している人は何人いるでしょうか？Excelは？

- あなたの会社で要らなくなったsoftwareはありませんか？使わなくなったsoftwareの機能は何年稼働しましたか？

これらの疑問に答える過程で、**「ユーザーはほとんどの機能を（あるいはsoftware自体を）使いこなせないことが分かると思います。**

**生産性を意識しいないエンジニアはこのことを意識することができず、結果的に余分なコードを生み出します。**

余分なコードが出てくることには次のデメリットがあります。

- 保守性しなけらばならない範囲が増える

- ユーザーが本当に必要としている機能を探せなくなる

- 改修できなくなる

このように余分なコードが増えることは全体的にデメリットしかありません。

**The Zen Programmerは違います。コードを生み出すのではなく、削除するのです。**



```
コードを書くのはとても簡単です。
実際、プログラマーの「価値」が、毎日書かれるコード行数で測定される時代がありました。
そしておそらくまだいくつかの場所で存在しています。

現在、焦点はより質対量です。
したがって、優れたプログラマーは、コミットする前にコードを確認し、より適切な用語が必要な場合はコードを「正当化」することが期待されます。
```

参考

https://www.quora.com/What-does-it-mean-that-zen-programmers-delete-code


## コードレビュー手順

Google では、変更をコードベースにコミットする前にコードレビューが行われます。

コードレビューの主な最終目標は、別のエンジニアに変更に同意してもらうことです。

これは、変更に **「Looks Good To Me(自分はいいと思います。)」(LGTM)** というタグを付けることで示されます。


1. ユーザーが自分のワークスペースでコードベースに変更を書き込みます。

2. コードレビューツールにアップロードされるパッチと対応する説明を作成します。`git commit & git push`。これはスナップショットと呼ばます。 この手順により、どのコードが変更されたかを評価するために使用される差分`git diff`が生成されます。

3. 作成者が変更の差分に満足したら、その変更を1人または複数のレビュアーにメールします。このプロセスは、それらのレビュアーに通知し、スナップショットを表示してコメントするよう依頼します。

4. レビュアーはコードレビューツールで変更を開き、差分にコメントを投稿します

    - 一部のコメントは、明示的な解決を要求しています。

    - また、ある一部のコメントは単なる情報提供です。

5. 作成者はフィードバックに基づいて変更を修正し、新しいスナップショットをアップロードしてから、レビュー担当者に再度以来します。**手順3と4と5は複数回繰り返すことがあります。**

6. レビュー担当者は、変更の最新の状態に満足した後、変更に同意し、"look good to me" (LGTM) としてマークして受け入れます。 **デフォルトで必要な LGTM は 1 つだけですが、規約により、すべてのレビュー担当者が変更に同意することが要求される場合があります。**


7. 変更がLGTMとマークされた後、作成者はすべてのコメントを解決し変更が承認された場合に、変更をコードベースにコミットすることができます。



## コードレビューのメリット

- コードの正確性をチェックする

    バグの混入を事前に防げるというメリットです。

    IBM の調査によると、当然のことながら、プロセスの早い段階で欠陥を発見すると、後で修正するために必要な時間が短縮されることが報告されています。（ソースは見つけられませんでした...）

- コードの変更が他のエンジニアに理解できるようにする

    **コードは書くよりも読まれる時間の方が長いです。**

- コードベース全体で一貫性を確保

    機能の重複、車輪の際発明を事前に防ぎます。

- チームの所有権を心理的に促進する

    ソースの私物化を防ぎ、「最も重要なのはチームの先にいるユーザーの利益」であることを意識させます。

- 知識の共有を可能にします

    コードの書き方だけでなく、システムの仕組みのキャッチアップに繋がります。


これらの利点の多くは、時間の経過とともにソフトウェア組織にとってより有益になります。

また、恩恵を受けるのは開発者だけでなくレビュー担当者も該当します。


## コードレビューの注意点（やってはいけないこと）

### レビュアーは、個人的な意見のために代替案を提案するべきではありません。

レビュアーは、個人的な意見のために代替案を提案するべきではありません。

レビュー担当者は代替案を提案できますが、それは

- 理解を改善する (たとえば、複雑さを軽減する、より理解しやすいアルゴリズムを提案するなど)

- または機能性を改善する (たとえば、between演算子を用いた高速化)

する場合に限られます。

驚くべきことに、コードの正確性をチェックすることは、Google がコード レビューのプロセスから得る主な利点ではありません。
より重要なのは、**時間の経過やコードベース自体のスケーリングに応じて意味があることを確認することです。**

ですから、結果を得るためにコードレビューは「完璧」である必要はありません。
コードレビューについては特別時間を割く必要はなく、問題がなければすぐにマージさせて次の作業に移りましょう。


### 速度やアルゴリズムの完璧性のみを追求する

コードレビューの本質は、開発者に偏りのないフィードバックを提供することです。

多くの場合、**コード レビューは特定の変更がより多くの聴衆に理解できるかどうかの最初のテスト**となります。

このテストを通過できない場合、コードにコメントやアルゴリズムの改善を要求する必要があるでしょう。

そのためにも、レビューを行うエンジニアは**あえて別のプロジェクトにいる、特に仕事の一環として変更内で提案されているコードを維持または使用する必要がある人物が最適**と言えるでしょう。



### コードの一貫性を「知っているふりをする」

一貫性のあるコードベースを使用すると、エンジニアが他の人のプロジェクトに介入してコードをレビューすることが容易になります。
ですが、システムに存在するすべてのコードの法則を、一人のリードエンジニアが知っているとは限りません。
そのためエンジニアは、コードレビューで助けを求めてチームの外に目を向ける必要がある場合があります。

専門家に連絡してコードのレビューを依頼することができ、専門家はコード自体の一貫性を期待できることを知っているため、エンジニアはコードの正確性と理解により適切に集中することができます。


### ソースコードを私物化するような発言

- 文化的な側面

コード レビューには、重要な文化的利点もあります。

コードレビューには、「コードは自分のものではなく実際には集団企業の一部である」ことをソフトウェアエンジニアに思い起こさせる役割を果たします。

コード レビューがなければ、ほとんどのエンジニアは自然に個人的なスタイルやソフトウェア設計への独自のアプローチに引き寄せられるでしょう。

- 精神の浄化作用

コード レビューのもう 1 つの心理的利点は検証です。

最も有能なエンジニアでさえ、インポスター症候群に陥ったり、自己批判的になりすぎたりすることがあります。

この疑心暗鬼状態を個人の価値観に頼らず、客観的に判断できるのもメリットです。


### 知らなかったことを認めない

最も重要だが過小評価されているコード レビューの利点の 1 つは、知識の共有です。

査読対象の分野の専門家、または少なくとも知識のある査読者を選びますが、それでもレビューの際にはレビュアーが知らなかった用語やアルゴリズムや言語の仕様に出会うことになります。

実際、多くのコード レビューでは双方向の情報交換が行われます。

```
ある社内SEのサイトの改修での話

海外からの注文時に「日付と曜日がずれてしまう」という問題がありました。
この問題の原因をさかのぼると、Javascriptのある一行に当たります。

var show_date = new Date(server_response_date)

おそらくこのコードだけを見て原因が何かを把握できるエンジニアはほとんどいないと思います。
（わかる人はコメントかツイッターで教えてください）

実際この奇妙な現象を初めて知ったとき、「これはJavascriptの欠点の一つではないか？」とさえおもいましたし、
おそらくこのコードのレビューを行った先輩もJavascriptの仕様であることを知らなかったと思います。
```


### 複数人でレビューする

Googleでのほとんどのコード レビューは 、正確に 1 人のレビュアーによってレビューされます。

実際のコードレビュープロセスでも、コードの正確性、所有者の承認、および言語の読みやすさに関する部分を1人の担当者が処理できるため、コード レビュープロセスは、Googleの規模の組織全体で非常にうまくスケーリングされます。

**確かに、業界内でも個人内でもさまざまな分野のエンジニアから追加の意見 (および全会一致の同意) を得ようとする傾向があります。しかし、これは収益の減少につながることがわかりました。**

最も重要な LGTMは最初のLGTMであり、その後のLGTMは、あなたが考えているほど意味を成しません。レビュー担当者を追加するコストは、すぐにその価値を上回ります。

規約の観点でレビューをする人間を別で用意してもいいかもしれませんが、可能ならば一人のレビューのみで十分でしょう。


## 結論

コードレビューは謙虚にいこう！



## 備考

title:コードレビューでやってはいけない6つのこと

description:

category_script:True

img:https://techblog.gmo-ap.jp/wp-content/uploads/2017/09/b6bf0ae3ff4611fac65e03c560475ffe.png