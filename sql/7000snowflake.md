

- [snowflakeの基礎](#snowflakeの基礎)
  - [仮想ウェアハウスタイプ](#仮想ウェアハウスタイプ)
    - [請求について](#請求について)
      - [請求についての注意事項](#請求についての注意事項)
  - [ウェアハウスのサイズ変更について](#ウェアハウスのサイズ変更について)
  - [パフォーマンスのためにスケールをあげる](#パフォーマンスのためにスケールをあげる)
  - [Snowflakeのクエリ結果取得キャッシュを無効にする方法](#snowflakeのクエリ結果取得キャッシュを無効にする方法)
  - [Snowflakeの実行時間の調べ方](#snowflakeの実行時間の調べ方)
- [snowflakeへの接続方法(クライアント、コネクタ、エコシステム)](#snowflakeへの接続方法クライアントコネクタエコシステム)
  - [接続情報についての補足/注意事項](#接続情報についての補足注意事項)
  - [webUI](#webui)
  - [SNNOW SQL](#snnow-sql)
    - [セットアップ方法](#セットアップ方法)
    - [snowflakeコマンドライン起動方法](#snowflakeコマンドライン起動方法)
    - [.snowsql内部の設定ファイル:接続情報のデフォルト設定　](#snowsql内部の設定ファイル接続情報のデフォルト設定)
    - [対応しているコネクタ一覧](#対応しているコネクタ一覧)
  - [snowflakeのエコシステム概要](#snowflakeのエコシステム概要)
    - [エコシステムの検索方法](#エコシステムの検索方法)
- [snowflakeのキャッシング](#snowflakeのキャッシング)
  - [メタデータキャッシュ](#メタデータキャッシュ)
    - [メタデータキャッシュの有効性を確認するSQL](#メタデータキャッシュの有効性を確認するsql)
  - [クエリレザルトキャッシュ](#クエリレザルトキャッシュ)
    - [クエリレザルとキャッシュを確認するクエリ](#クエリレザルとキャッシュを確認するクエリ)
  - [ローカルディスクキャッシュ](#ローカルディスクキャッシュ)
  - [備考](#備考)





# snowflakeの基礎


## 仮想ウェアハウスタイプ

- 標準
    - コンピュートクラスタは一つだけ
    - スケールアウトができない


- マルチクラスターウェアハウス（MCW)
    - 追加のコンピュートクラスタを生成可能せ。多くのユーザーと同時実効性のニーズに対応できる。


### 請求について

**コンピュートクレジットは使用する仮想ウェアの数、サイズ、使用量に依存する。**
よくあるアカウントの数での請求ではないため、比較的安く済むのが特徴。

コンピュートクレジットはコンピューターの使用量に対する請求方式

一定数のクレジットを持っている場合（キャパシティ、前払い）

オンデマンド、クレジットの倍は毎月は毎月請求される

#### 請求についての注意事項

- 一部のコンピュートはクラウドサービスレイヤで動作する。
その場合は、クラウドサービスレイヤで課金される。
しかし、そこまでたくさん出てくる請求ではない。

**アカウントの合計コンピュートの10%を超える場合のみ、請求される**

- データウェアレイヤーで、に120クレジットの10％は12クレジット。

- クラウドサービスレイヤで、10クレジット発生した


## ウェアハウスのサイズ変更について

- 実行中でああってもサイズ変更は可能
 
- ALTER WAREHOUSEステートメントまたはUIを介して変更

ただし注意点

- 一時停止中のウェアハウスは、次の起動時に新しいサイズでかいし
- 実行中のウェアハウスは、実行中のクエリに影響を及ぼすことはできない、キュー待ちに入っていたクエリは新しいサイズで実行される。


## パフォーマンスのためにスケールをあげる

弾力性のある処理能力について

- **大きなデータセットに対して**複雑なクエリを実行する場合には、**大きなウェアハウスを用意するのは効果がある**
- ただし、大きなウェアハウスを用意しても**同時実効性が上がるものではない。**
- *同時実効性については、ウェアハウスのコンピュータークラスタの数を増減させることで対応可能。
  - MIN_CLUSTER_COUNT : 1~10
  - MAX_CLUSTER_COUNT : 1~10

WAREHOUSEのサンプルコードは以下の通り

```sql
ALTER WAREHOUSE [WAREHOUSE名]
    SET
    WAREHOUSE_SIZE = Small
    MAX_CLUSTER_COUNT = 3
```


## Snowflakeのクエリ結果取得キャッシュを無効にする方法

次のALTER文でキャッシュを無効にすることができる。

`ALTER SESSION SET USE_CACHED_RESULT = FALSE`



## Snowflakeの実行時間の調べ方

- **SQLを流した後、 *クエリID* が左下に出現する。**
その`クエリID`をクリックした後、左側のポップアップから実行時間が確認できる。その際に見るべき項目は、`期間の合計`

ここではポップアップ画面だけでなく、**そのクエリがキャッシュデータを使用したのかどうかを確認できる。**

- あるいは、`履歴` ページに表示されるクエリ情報からも確認が可能



# snowflakeへの接続方法(クライアント、コネクタ、エコシステム)

snowflakeはよくあるクライアントツールから接続できるようになっている。

snowflakeを使用する方法

- webベースのユーザーインターフェイス

- コマンドラインツール、snowsql

- ODBCドライバ、JDBCドライバー、Tableau

- ネイティブコネクター(Pythonなど)

- サードパーティソリューション（ETLツールなど）


## 接続情報についての補足/注意事項

snowflakeは外部のストレージに依存する。
**その依存先のストレージによって、接続先のurlが異なる**


- AWSアメリカ西部：`＜アカウント名＞.snowflakecomputing.com`

- AWSの全ての地域：`＜アカウント名＞.＜地域＞.snowflakecomputing.com`

- 他の全てのプロバイダー：`＜アカウント名＞.＜地域＞.＜プロバイダー＞.snowflakecomputing.com`


## webUI

Snowflakeの`WebUI`ではほとんど全ての操作が可能。
ユーザー管理やワークシートを活用したSQLの実行など。

- ワークシートコンテキストでは、ワークシートで実行される使用されるデフォルトの名前空間、ロール、ウェアハウスを左上のUIから設定すること。あるいは、USE コマンドで名前空間、ロール、ウェアハウスを変更可能

- また、**現在のロールで使用できるデータベースオブジェクトを左のポップアップから確認が可能**。ただし、*今見えているデータベースやオブジェクトだけが実行可能なわけではないことに注意。*

- クエリペインから、SQLを入力可能。結果ペインから実行結果が表形式で確認できる。


## SNNOW SQL

Snowflakeに接続するためのコマンドラインインターフェイス

- Pythonのようなsnowflkeコネクタを使用して開発する

- インタラクティブシェルとして、またはバッチファイルとして実行可能



### セットアップ方法

1. ヘルプ
2. ダウンロード
3. 新しいいボックスから「CLIクライアント」を選ぶ 
4. ftpディレクトリに移動するので、対応するOSを選択してダウンロード、インストールする

### snowflakeコマンドライン起動方法

`snowsql -a acount -u username`

Password:と表示されるので、パスワードを入力する

### .snowsql内部の設定ファイル:接続情報のデフォルト設定　

snowsqlを実行すると、`.snowsql`が作成される。
そして、その中の`condif`ファイルに接続情報などが格納される。
そして、`config`ファイルの中にある`[connectiohns]`の内部にユーザー名とパスワードを入力することで、**そのユーザーはsnowsqlの実行時にユーザー情報を入力せずにすむ。**
 
また、接続情報を`[conneciton.bad1]`というように、`.`をつけることで、別の接続情報でsnowsqlから接続できる

サンプル接続コード:
`snowsql -c bad1`


### 対応しているコネクタ一覧

- python

- node.js

- GO

- .NETフレームワーク

- JDBC

- ODBC

- php


## snowflakeのエコシステム概要

<img src="https://docs.snowflake.com/ja/_images/ecosystem-overview.png">

snowflakeには凄まじい数のエコシステムが存在する。
彼らがライブラリーやコネクタを提供してくれるので、snowflakeはさまざまな環境で使用できる。

### エコシステムの検索方法

- snowflakeのwebuiから確認する

- パートナー接続

- パートナーのアイコンが存在するため、必要なものを選択

- 必要に応じてリンクを移動したり、ポップアップが出現したりする。

**注意事項としては、「ロール」から「ACOUNT/ADMIN」を選択する必要がある。**


# snowflakeのキャッシング

snowflakeの三つのレイヤーのうち、クラウドサービスとコンピュートのレイヤーでキャッシュが動作する。

- クラウドサービスでは、「メタデータキャッシュ」「クエリレザルトキャッシュ」の二つが

- コンピュートレイヤーでは、「ローカルディスクキャッシュ」が働く

<img src="https://beyondjapan.com/cms/wp-content/uploads/2020/09/Snowflake_%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3.png">
from https://beyondjapan.com/blog/2020/09/snowflake/

各レイヤーの情報は上図の通り。

流れとしては

1. クエリリザルトキャッシュ内部に結果があるか確認し、データが変更されていないかを確認する
2. メタデータキャッシュに結果がないかを確認する。
3. ローカルディスクキャッシュに結果がないかを確認する。
4. 上記にデータがなければ実行

## メタデータキャッシュ

**クエリ処理中に高速にアクセスするために利用するメタデータ**

- データベースの高速化に貢献されている

- パーテションの列レベルのメタデータ
  - 最小値
  - 個別値の数
  - NULLの数
  - SHOWコマンド
  - MIN,MAX,COUNT関数
 
- 仮想ウェアハウスを利用する必要がない。（ただしクラウドサービスの料金がまれに適用されます）


### メタデータキャッシュの有効性を確認するSQL

1.クエリリザルトキャッシュを使用しないように、`USE_CACHED_RESULT`を無効にします。

`ALTER SESSION USE_CACHED_RESULT = FALSE`

2.次のクエリを実行すると、キャッシュを使用しているため一瞬で結果が表示されます。

`SELECT MIN(l_orderkey), MAX(l_orderkey) , COUNT(*) from lineitem`

3.結果ペインにあるクエリIDをクリックすることで、プロファイルを開けます。

4.プロファイルタブを確認すると、**結果はメタデータキャッシュに100%由来していることがわかります**




## クエリレザルトキャッシュ

**同一のクエリが実行された場合かつ、ベースのテーブルが変更されていない場合に、クエリ結果を再利用してくれる。** 仮想ウェアハウスのコンピュートを必要とせずに、再利用できるようにキャッシュされた結果をそのまま返す。

- 他のユーザーがキャッシを利用可能な場合もある
  - SHOW : 同じロールの全てのユーザー
  - SELECT : クエリ内の全てのテーブルに対するSELEÇT権限を持つ全てのユーザー
- これらのユーザーのみがおなじクエリの結果を再利用できる。

- 結果セットは、**24時間**キャッシュされ、一致するクエリが再利用されるたびにカウントされる。また、最大で**31日間**クエリのキャッシュが有効になる。

- 結果の再利用は、アカウント/ユーザー/セッションレベルで有効無効をコントロールできる。`USE_CACHE_RESULT`パラメーターで制御可能

- 結果セットのキャッシュを使用するためには条件がある
  - 全く同じクエリ(空白を除く)
  - 結果が決定的で、ランダム関数がないこと
  - キャッシュ利用権限があること

- コンピュートレイヤ、ストレージレイヤを利用していない

-  WEBUIからのSQLでキャッシュを利用した後は、Profileに`QUERY_RESULT_REUSE`のフラグが表示される

- <img src="https://d1tlzifd8jdoy4.cloudfront.net/wp-content/uploads/2020/01/2020-01-20_17h35_48.png">
from https://dev.classmethod.jp/articles/snowflake-cache-three/

- 完全に同一のクエリでなくとも、キャッシュを利用してくれることもある

例
```sql
select * from A
```
このクエリを実行した後、where句を利用する場合、例えば

```sql
select * from A where id="1234"
```

を実行するときは、元のクエリが再利用される。


### クエリレザルとキャッシュを確認するクエリ

1. 以下のクエリを実行します

```sql
select * from lineitem
```

2. 上のクエリとにている次のクエリを実行します

```sql
select
    *
from (select * from lineitem) A
where
    A.id = '1234'
```

3. この状態でクエリIDからプロフィールを確認すると、キャッシュを再利用していることが確認できます。



## ローカルディスクキャッシュ

仮想ウェアハウスのSSD内部に、キャッシュされたデータ

- 例えば、`SELECT network FROM rating WHERE (data_stream = live)`を実行した場合。

- ローカルディスクには
   - data_stream = 'Live'
   - network
- がキャッシュとして格納される。

**仮想ウェアハウスは、最初にローカルで利用なデータを読み取り、次にリモートクラウドストレージから残りを読み取る**

- ローカルディスクキャッシュは、Profileから確認できる

- <img src="https://d1tlzifd8jdoy4.cloudfront.net/wp-content/uploads/2020/01/dc2.png">

- この場合は、データの100%をローカルキャッシュから取れた。

- from https://dev.classmethod.jp/articles/snowflake-cache-three/


- キャッシュの有効期限は、**ウェアハウスが存在する間なので、キャッシュを優先す流場合はウェアハウスは止めないようにすること**



























## 備考

title:snowflake完全解説

img:https://beyondjapan.com/cms/wp-content/uploads/2020/09/Snowflake_%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3.png

from https://beyondjapan.com/blog/2020/09/snowflake/



